<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OAuth callback</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  </head>
  <body>
    <script>
      (function(){
        try {
          const params = new URLSearchParams(window.location.search);
          const token = params.get('auth_token') || params.get('token');
          if (token) {
            // If opened as a popup by the main app, postMessage the token and close
            try {
              if (window.opener && !window.opener.closed) {
                // Some browsers prevent reading opener.location when cross-origin.
                // Use '*' as targetOrigin to ensure the message is delivered; the
                // opener should verify origin if needed.
                try { window.opener.postMessage({ type: 'fauves_oauth', token }, '*'); } catch(e) { /* ignore */ }
                // Also persist to localStorage as a fallback
                try { localStorage.setItem('AUTH_TOKEN_V1', token); } catch(e) {}
                window.close();
                return;
              }
            } catch(e) {}

            // Not a popup (direct navigation) -> redirect to home with token still in query (AuthProvider will pick it up)
            const home = '/?auth_token=' + encodeURIComponent(token);
            window.location.replace(home);
            return;
          }
        } catch (e) {}
        // Nothing to do
        document.body.innerText = 'OAuth callback received no token.';
      })();
    </script>
  </body>
</html>
